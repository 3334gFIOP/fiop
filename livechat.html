<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <link rel="icon" href="images/icon.png" type="image/png"/>
    <link rel="stylesheet" href="stylesheet.css">
    <style>
        body.chat-page {
            font-family: Arial, sans-serif;
            background: #000000;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        h1 { margin-left: 10px; }
        p { color: #fff; margin-left: 10px; }

        #chat-wrapper {
            display: none; /* Hidden until login */
            gap: 20px;
            margin-left: 10px;
        }

        #chat-container {
            width: 400px;
            height: 500px;
            border: 1px solid #555;
            display: flex;
            flex-direction: column;
        }

        #messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            border-bottom: 1px solid #38344a;
        }

        #message-input, #name-input {
            padding: 10px;
            border: none;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 5px;
        }

        #send-btn, #set-name-btn {
            padding: 0px;
            border: none;
            background: #23002d;
            color: white;
            cursor: pointer;
            margin-bottom: 0px;
        }
        #send-btn:hover, #set-name-btn:hover {
            background: #46005a;
        }

        .message { margin-bottom: 10px; }
        .member { font-weight: bold; margin-right: 5px; }

        .system-message { 
            font-size: 0.9em; 
            font-style: italic;
        }

        #user-list {
            width: 180px;
            height: 480px;
            border: 1px solid #555;
            padding: 10px;
            overflow-y: auto;
        }

        #user-list h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .user-item {
            font-weight: bold;
            margin-bottom: 8px;
        }
    </style>
</head>
<body class="chat-page">

<h1 class="outlined-text">Chat</h1>
<p>Live Online Chat Thingy (set name to join the chat)</p>

<!-- Name + Color input -->
<div style="margin-left:10px; margin-bottom: 10px;">
    <input style="width: 200px;" type="text" id="name-input" placeholder="Enter your name">
    <input type="color" id="color-input" value="#ff0000" style="margin-left: 5px; width: 30px; height: 30px; padding:0; border:none;">
    <button id="set-name-btn">Set Name</button>
</div>

<div id="chat-wrapper">
    <div id="chat-container">
        <div id="messages"></div>
        <input type="text" id="message-input" placeholder="Type a message..." disabled>
        <button id="send-btn" disabled>Send</button>
    </div>

    <div id="user-list">
        <h3>Online Users</h3>
    </div>
</div>

<br><br>
<a href="https://fiop.dev" class="glow-btn" style="margin-left:10px;">Back to home</a>

<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
<script>
const CLIENT_ID = "6J1HwHleZ1C79oUB";

let username = "";
let userColor = "";
let members = [];
let drone;
let room;

/* BAD WORD FILTER */
const badWords = ["arsehole","asshat","asshole","bastard","big black cock","bitch","bloody",
    "blowjob","bollocks","bugger","bullshit","chicken shit","ching chong","clusterfuck","cock",
    "cocksucker","coonass","cornhole","coxâ€“zucker machine","cracker","crap","cunt","dick","dumbass",
    "enshittification","faggot","feck","fuck","fuck her right in the pussy","fuck joe biden",
    "fuck, marry, kill","fuckery","grab 'em by the pussy","healslut","if you see kay",
    "jesus fucking christ","kike","motherfucker","nigga","nigger","pajeet","paki","poof","poofter",
    "prick","pussy","ratfucking","retard","russian warship, go fuck yourself","serving cunt","shit",
    "shit happens","shithouse","shitposting","shitter","shut the fuck up","shut the hell up",
    "slut","son of a bitch","spic","taking the piss","twat","unclefucker","wanker","whore"
];

function cleanText(text) {
    let clean = text;
    badWords.forEach(word => clean = clean.replace(new RegExp(word, "gi"), "****"));
    return clean;
}

/* PRELOAD MEMBERS */
const preload = new ScaleDrone(CLIENT_ID);
preload.on("open", () => {
    const preloadRoom = preload.subscribe("observable-room");

    preloadRoom.on("members", m => { members = m; });
    preloadRoom.on("member_join", m => members.push(m));
    preloadRoom.on("member_leave", ({id}) => {
        members = members.filter(mem => mem.id !== id);
    });
});

/* USER SELECTS NAME */
document.getElementById("set-name-btn").addEventListener("click", () => {
    const name = document.getElementById("name-input").value.trim();
    const color = document.getElementById("color-input").value;

    if (!name) return;

    const taken = members.some(m => m.clientData && m.clientData.name.toLowerCase() === name.toLowerCase());
    if (taken) {
        alert("That name is already taken.");
        return;
    }

    username = cleanText(name);
    userColor = color;

    drone = new ScaleDrone(CLIENT_ID, {
        data: { name: username, color: userColor }
    });

    connectChat();

    document.getElementById("message-input").disabled = false;
    document.getElementById("send-btn").disabled = false;
    document.getElementById("chat-wrapper").style.display = "flex";

    document.getElementById("name-input").disabled = true;
    document.getElementById("color-input").disabled = true;
    document.getElementById("set-name-btn").disabled = true;
});

/* CONNECT CHAT */
function connectChat() {
    drone.on("open", err => {
        if (err) return console.error(err);

        room = drone.subscribe("observable-room");

        room.on("members", m => {
            members = m;
            updateUserList();
        });

        room.on("member_join", m => {
            members.push(m);
            updateUserList();
            if (m.clientData && m.clientData.name !== username) {
                addSystemMessage(`${m.clientData.name} joined the chat`, "green");
            }
        });

        room.on("member_leave", ({id}) => {
            const member = members.find(mem => mem.id === id);
            members = members.filter(mem => mem.id !== id);
            updateUserList();
            if (member && member.clientData) {
                addSystemMessage(`${member.clientData.name} left the chat`, "red");
            }
        });

        room.on("data", (msg, member) => {
            if (!member) return;
            addMessage(cleanText(msg), member);
        });
    });
}

/* SEND MESSAGE */
function sendMessage() {
    const input = document.getElementById("message-input");
    const value = input.value.trim();
    if (!value) return;
    input.value = "";
    drone.publish({ room: "observable-room", message: value });
}

document.getElementById("send-btn").addEventListener("click", sendMessage);
document.getElementById("message-input").addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

/* RENDERING */
function addMessage(text, member) {
    const wrap = document.getElementById("messages");
    const div = document.createElement("div");

    div.className = "message";

    const name = document.createElement("span");
    name.className = "member";
    name.style.color = member.clientData.color;
    name.textContent = member.clientData.name + ": ";

    div.appendChild(name);
    div.appendChild(document.createTextNode(text));

    wrap.appendChild(div);
    wrap.scrollTop = wrap.scrollHeight;
}

function addSystemMessage(text, color) {
    const wrap = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = "system-message";
    div.style.color = color;
    div.textContent = text;
    wrap.appendChild(div);
    wrap.scrollTop = wrap.scrollHeight;
}

function updateUserList() {
    const list = document.getElementById("user-list");
    list.innerHTML = "<h3>Online Users</h3>";
    members.forEach(m => {
        if (!m.clientData) return;
        const div = document.createElement("div");
        div.className = "user-item";
        div.textContent = m.clientData.name;
        div.style.color = m.clientData.color;
        list.appendChild(div);
    });
}
</script>

</body>
</html>
